<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SmartFold â€” My Dashboard</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
        /* User Dashboard Layout */
        .user-layout {
            min-height: 100vh;
            padding-top: 100px;
        }

        /* Floating Navbar */
        .user-navbar {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: min(1200px, 94vw);
            z-index: 100;
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .nav-brand {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #38BDF8 0%, #818CF8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-tabs {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            padding: 6px;
            border-radius: 16px;
        }

        .nav-tab {
            padding: 10px 20px;
            border-radius: 12px;
            color: var(--text-muted);
            font-weight: 500;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: none;
        }

        .nav-tab:hover {
            color: var(--primary);
            background: rgba(56, 189, 248, 0.1);
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Main Content */
        .user-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px 60px;
        }

        /* Section Visibility */
        .user-section {
            display: none;
            animation: fadeSlide 0.4s ease;
        }

        .user-section.active {
            display: block;
        }

        @keyframes fadeSlide {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Page Header */
        .page-hero {
            text-align: center;
            padding: 40px 0;
            margin-bottom: 32px;
        }

        .page-hero h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--heading);
            margin-bottom: 12px;
        }

        .page-hero p {
            font-size: 1.1rem;
            color: var(--text-muted);
        }

        /* Place Order Layout */
        .order-layout {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 32px;
            align-items: start;
        }

        @media (max-width: 900px) {
            .order-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Service Cards */
        .services-section h2 {
            font-size: 1.25rem;
            margin-bottom: 20px;
            color: var(--heading);
        }

        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .service-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .service-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #38BDF8, #818CF8);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .service-card:hover {
            border-color: rgba(56, 189, 248, 0.4);
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }

        .service-card:hover::before {
            opacity: 1;
        }

        .service-card.selected {
            border-color: var(--primary);
            background: rgba(56, 189, 248, 0.08);
        }

        .service-card.selected::before {
            opacity: 1;
        }

        .service-icon {
            font-size: 2rem;
            margin-bottom: 12px;
        }

        .service-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--heading);
            margin-bottom: 8px;
        }

        .service-desc {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .service-price {
            font-size: 1rem;
            font-weight: 700;
        }

        .service-price span {
            color: var(--primary);
        }

        .service-btn {
            width: 100%;
            margin-top: 16px;
            padding: 12px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.2s;
        }

        /* Order Summary Panel */
        .summary-panel {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 28px;
            position: sticky;
            top: 110px;
        }

        .summary-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--heading);
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .datetime-group {
            margin-bottom: 20px;
        }

        .datetime-group label {
            display: block;
            font-weight: 600;
            color: var(--heading);
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .datetime-group input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-main);
            font-size: 0.95rem;
        }

        .datetime-group input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.15);
        }

        .order-items-list {
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            padding: 16px 0;
            margin: 16px 0;
            min-height: 100px;
        }

        .empty-cart {
            text-align: center;
            color: var(--muted);
            padding: 20px;
            font-size: 0.9rem;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px dashed var(--border);
        }

        .order-item:last-child {
            border-bottom: none;
        }

        .order-item-name {
            font-weight: 600;
            color: var(--heading);
        }

        .order-item-price {
            color: var(--primary);
            font-weight: 700;
        }

        .order-item-remove {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 12px;
        }

        /* Add-ons */
        .addons-section {
            margin: 20px 0;
        }

        .addon-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .addon-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--primary);
        }

        .addon-label {
            flex: 1;
            font-size: 0.9rem;
            color: var(--heading);
        }

        /* Totals */
        .totals-section {
            margin-top: 20px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 0.95rem;
            color: var(--text-muted);
        }

        .total-row.grand-total {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--heading);
            border-top: 2px solid var(--border);
            padding-top: 16px;
            margin-top: 8px;
        }

        .place-order-btn {
            width: 100%;
            margin-top: 24px;
            padding: 16px;
            font-size: 1.1rem;
            font-weight: 700;
            border-radius: 14px;
            background: linear-gradient(135deg, #38BDF8 0%, #818CF8 100%);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .place-order-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(56, 189, 248, 0.3);
        }

        .place-order-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 32px;
            width: min(480px, 90vw);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .modal-header h3 {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--muted);
            cursor: pointer;
        }

        .kg-input-group {
            margin-bottom: 20px;
        }

        .kg-input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .kg-input-group input {
            width: 100%;
            padding: 14px;
            font-size: 1.1rem;
            border-radius: 12px;
        }

        .kg-preview {
            background: rgba(56, 189, 248, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .kg-preview .price {
            font-size: 2rem;
            font-weight: 800;
            color: var(--primary);
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-footer button {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            font-weight: 600;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            color: var(--text-muted);
        }

        .btn-confirm {
            background: linear-gradient(135deg, #38BDF8, #818CF8);
            color: white;
            border: none;
        }

        /* Category Table */
        .category-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .category-table th {
            text-align: left;
            padding: 12px;
            font-size: 0.8rem;
            color: var(--muted);
            text-transform: uppercase;
            border-bottom: 1px solid var(--border);
        }

        .category-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }

        .category-table input[type="number"] {
            width: 70px;
            padding: 8px;
            border-radius: 8px;
            text-align: center;
        }

        .category-total {
            background: rgba(56, 189, 248, 0.1);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        /* My Orders Section */
        .orders-grid {
            display: grid;
            gap: 16px;
        }

        .order-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 16px;
            align-items: center;
        }

        .order-info h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .order-meta {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: var(--muted);
        }

        .order-status {
            text-align: right;
        }

        .order-amount {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        /* Status Badges */
        .badge {
            display: inline-flex;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge.pending {
            background: rgba(250, 204, 21, 0.15);
            color: #facc15;
        }

        .badge.processing {
            background: rgba(56, 189, 248, 0.15);
            color: #38bdf8;
        }

        .badge.ready {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        .badge.delivered {
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
        }

        /* Support Section */
        .support-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
        }

        @media (max-width: 768px) {
            .support-layout {
                grid-template-columns: 1fr;
            }
        }

        .support-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 28px;
        }

        .support-card h3 {
            margin-bottom: 20px;
        }

        .chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .chat-input {
            display: flex;
            gap: 12px;
        }

        .chat-input input {
            flex: 1;
        }

        .faq-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .faq-item {
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .faq-item:last-child {
            border-bottom: none;
        }

        .faq-question {
            font-weight: 600;
            color: var(--heading);
            margin-bottom: 8px;
        }

        .faq-answer {
            font-size: 0.9rem;
            color: var(--muted);
        }
    </style>
</head>

<body data-theme="dark">
    <div class="user-layout">
        <!-- Navigation -->
        <nav class="user-navbar">
            <div class="nav-brand">SmartFold</div>
            <div class="nav-tabs">
                <button class="nav-tab active" data-section="place-order">ðŸ›’ Place Order</button>
                <button class="nav-tab" data-section="my-orders">ðŸ“¦ My Orders</button>
                <button class="nav-tab" data-section="support">ðŸ’¬ Support</button>
            </div>
            <div class="nav-actions">
                <button id="logout-btn" class="btn-danger btn-pill">Logout</button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="user-content">
            <!-- Place Order Section -->
            <section id="place-order" class="user-section active">
                <div class="page-hero">
                    <h1>ðŸ§º Place New Laundry Order</h1>
                    <p>Select your services and we'll take care of the rest</p>
                </div>

                <div class="order-layout">
                    <!-- Services Grid -->
                    <div class="services-section">
                        <h2>Select Your Services</h2>
                        <div class="service-grid">
                            <!-- Laundry (Wash Only) -->
                            <div class="service-card" id="card-laundry">
                                <div class="service-icon">ðŸ«§</div>
                                <div class="service-name">Laundry (Wash Only)</div>
                                <div class="service-desc">Standard wash cycle for everyday garments. Billed per
                                    kilogram.</div>
                                <div class="service-price"><span>250 LKR</span> per kg</div>
                                <button class="service-btn btn-primary"
                                    onclick="openKgModal('laundry', 'Laundry (Wash Only)', 250)">Select</button>
                            </div>

                            <!-- Pressing (Iron Only) -->
                            <div class="service-card" id="card-pressing">
                                <div class="service-icon">ðŸ‘”</div>
                                <div class="service-name">Pressing (Iron Only)</div>
                                <div class="service-desc">Wrinkle-free finish for all garment types. Billed per item.
                                </div>
                                <div class="service-price">Prices vary by category</div>
                                <button class="service-btn btn-primary"
                                    onclick="openCategoryModal('pressing', 'Pressing (Iron Only)')">Select</button>
                            </div>

                            <!-- Wash & Iron -->
                            <div class="service-card" id="card-washiron">
                                <div class="service-icon">âœ¨</div>
                                <div class="service-name">Wash & Iron</div>
                                <div class="service-desc">Complete care: washed, dried, and expertly pressed.</div>
                                <div class="service-price">Pressing + <span>25 LKR</span> per item</div>
                                <button class="service-btn btn-primary"
                                    onclick="openCategoryModal('washiron', 'Wash \u0026 Iron')">Select</button>
                            </div>

                            <!-- Dry Cleaning -->
                            <div class="service-card" id="card-drycleaning">
                                <div class="service-icon">ðŸ§´</div>
                                <div class="service-name">Dry Cleaning</div>
                                <div class="service-desc">Professional solvent-based cleaning for delicate fabrics.
                                </div>
                                <div class="service-price"><span>400 LKR</span> per kg</div>
                                <button class="service-btn btn-primary"
                                    onclick="openKgModal('drycleaning', 'Dry Cleaning', 400)">Select</button>
                            </div>

                            <!-- Express Service -->
                            <div class="service-card" id="card-express">
                                <div class="service-icon">âš¡</div>
                                <div class="service-name">Express Service</div>
                                <div class="service-desc">Prioritize your order with 25% faster turnaround.</div>
                                <div class="service-price"><span>+25%</span> of selected services</div>
                                <button class="service-btn btn-secondary" onclick="toggleExpress()">Add to
                                    Order</button>
                            </div>

                            <!-- Premium Care -->
                            <div class="service-card" id="card-premium">
                                <div class="service-icon">ðŸ’Ž</div>
                                <div class="service-name">Premium / Delicate Care</div>
                                <div class="service-desc">Individually handled garments with delicate-only detergents.
                                </div>
                                <div class="service-price"><span>400 LKR</span> per item</div>
                                <button class="service-btn btn-secondary" onclick="togglePremium()">Add to
                                    Order</button>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="summary-panel">
                        <div class="summary-title">ðŸ›’ Order Summary</div>

                        <div class="datetime-group">
                            <label for="pickup-datetime">Pickup Date & Time</label>
                            <input type="datetime-local" id="pickup-datetime" onchange="validateDates()" />
                        </div>

                        <div class="datetime-group">
                            <label for="delivery-datetime">Delivery Date & Time</label>
                            <input type="datetime-local" id="delivery-datetime" onchange="validateDates()" />
                        </div>

                        <div class="order-items-list" id="order-items">
                            <div class="empty-cart">No services selected yet</div>
                        </div>

                        <div class="addons-section">
                            <div class="addon-option">
                                <input type="checkbox" id="addon-express" onchange="updateTotals()" />
                                <span class="addon-label">Express Service (+25%)</span>
                            </div>
                            <div class="addon-option">
                                <input type="checkbox" id="addon-premium" onchange="updateTotals()" />
                                <span class="addon-label">Premium Care (+LKR 400/item)</span>
                            </div>
                        </div>

                        <div class="totals-section">
                            <div class="total-row">
                                <span>Subtotal</span>
                                <span id="subtotal">LKR 0</span>
                            </div>
                            <div class="total-row" id="express-row" style="display: none;">
                                <span>Express (+25%)</span>
                                <span id="express-amount">LKR 0</span>
                            </div>
                            <div class="total-row" id="premium-row" style="display: none;">
                                <span>Premium Care</span>
                                <span id="premium-amount">LKR 0</span>
                            </div>
                            <div class="total-row grand-total">
                                <span>Total</span>
                                <span id="grand-total">LKR 0</span>
                            </div>
                        </div>

                        <button class="place-order-btn" id="btn-place-order" onclick="placeOrder()" disabled>
                            Place Order
                        </button>
                    </div>
                </div>
            </section>

            <!-- My Orders Section -->
            <section id="my-orders" class="user-section">
                <div class="page-hero">
                    <h1>ðŸ“¦ My Orders</h1>
                    <p>Track and manage your laundry orders</p>
                </div>

                <div class="orders-grid" id="orders-list">
                    <div class="order-card">
                        <div class="order-info">
                            <h3>Order #1047</h3>
                            <div class="order-meta">
                                <span>Wash & Iron â€¢ 5 items</span>
                                <span>Pickup: Jan 6, 2026</span>
                            </div>
                        </div>
                        <div class="order-status">
                            <div class="order-amount">LKR 1,250</div>
                            <span class="badge processing">Processing</span>
                        </div>
                    </div>
                    <div class="order-card">
                        <div class="order-info">
                            <h3>Order #1045</h3>
                            <div class="order-meta">
                                <span>Dry Cleaning â€¢ 2 kg</span>
                                <span>Delivered: Jan 3, 2026</span>
                            </div>
                        </div>
                        <div class="order-status">
                            <div class="order-amount">LKR 800</div>
                            <span class="badge delivered">Delivered</span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Support Section -->
            <section id="support" class="user-section">
                <div class="page-hero">
                    <h1>ðŸ’¬ Customer Support</h1>
                    <p>We're here to help you</p>
                </div>

                <div class="support-layout">
                    <div class="support-card">
                        <h3>Chat with Us</h3>
                        <div class="chat-messages" id="chat-messages">
                            <p style="color: var(--muted); text-align: center; padding: 40px 0;">
                                Start a conversation with our support team
                            </p>
                        </div>
                        <div class="chat-input">
                            <input type="text" id="chat-input" placeholder="Type your message..." />
                            <button class="btn-primary" onclick="sendMessage()">Send</button>
                        </div>
                    </div>

                    <div class="support-card">
                        <h3>Frequently Asked Questions</h3>
                        <ul class="faq-list">
                            <li class="faq-item">
                                <div class="faq-question">How do I track my order?</div>
                                <div class="faq-answer">You can track your order in the "My Orders" section. You'll also
                                    receive SMS updates.</div>
                            </li>
                            <li class="faq-item">
                                <div class="faq-question">What's the turnaround time?</div>
                                <div class="faq-answer">Standard orders: 48-72 hours. Express service: 24 hours.</div>
                            </li>
                            <li class="faq-item">
                                <div class="faq-question">How do I cancel an order?</div>
                                <div class="faq-answer">Contact us before pickup for a full refund. After pickup,
                                    cancellation fees may apply.</div>
                            </li>
                        </ul>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- KG Modal -->
    <div class="modal-overlay" id="kg-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="kg-modal-title">Service</h3>
                <button class="modal-close" onclick="closeKgModal()">&times;</button>
            </div>
            <div class="kg-input-group">
                <label>Enter weight (kg):</label>
                <input type="number" id="kg-input" min="0.5" step="0.5" value="1" oninput="updateKgPreview()" />
            </div>
            <div class="kg-preview">
                <p style="color: var(--muted); margin-bottom: 8px;">Estimated Price:</p>
                <p class="price" id="kg-preview-price">LKR 250</p>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeKgModal()">Cancel</button>
                <button class="btn-confirm" id="kg-confirm-btn" onclick="confirmKgService()">Add to Order</button>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div class="modal-overlay" id="category-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="category-modal-title">Service</h3>
                <button class="modal-close" onclick="closeCategoryModal()">&times;</button>
            </div>
            <table class="category-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Price/Item</th>
                        <th>Qty</th>
                    </tr>
                </thead>
                <tbody id="category-table-body"></tbody>
            </table>
            <div class="category-total">
                <p style="color: var(--muted);"><span id="category-items">0</span> items selected</p>
                <p class="price" id="category-total-price"
                    style="font-size: 1.5rem; font-weight: 800; color: var(--primary);">LKR 0</p>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeCategoryModal()">Cancel</button>
                <button class="btn-confirm" id="category-confirm-btn" onclick="confirmCategoryService()" disabled>Add to
                    Order</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { requireAuth, clearAuth, api, toastSuccess, toastError } from './js/common.js';

        // Check auth - allow both CUSTOMER and USER roles
        const user = requireAuth(["CUSTOMER", "USER"]);
        if (!user) {
            window.location.href = './login.html';
        }

        // Logout
        document.getElementById('logout-btn')?.addEventListener('click', () => {
            clearAuth();
            window.location.href = './login.html';
        });

        // Force dark theme (no toggle - cleaner UI)
        document.body.dataset.theme = 'dark';

        // Navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const section = tab.dataset.section;
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.querySelectorAll('.user-section').forEach(s => s.classList.remove('active'));
                document.getElementById(section)?.classList.add('active');
            });
        });

        // Expose toastSuccess globally for inline handlers
        window.toastSuccess = toastSuccess;
        window.toastError = toastError;
    </script>

    <script>
        // Pricing Data
        const CATEGORIES = [
            { name: 'Casual Wear', pressingPrice: 50, washIronPrice: 75 },
            { name: 'Formal Wear', pressingPrice: 75, washIronPrice: 100 },
            { name: 'Ethnic / Traditional', pressingPrice: 100, washIronPrice: 125 },
            { name: 'Bedding & Linen', pressingPrice: 120, washIronPrice: 145 },
            { name: 'Curtains & Drapes', pressingPrice: 150, washIronPrice: 175 },
            { name: 'Kids Wear', pressingPrice: 60, washIronPrice: 85 },
            { name: 'Delicates / Premium', pressingPrice: 200, washIronPrice: 225 }
        ];

        const PREMIUM_PER_ITEM = 400;
        const EXPRESS_MULTIPLIER = 0.25;

        // State
        let orderItems = [];
        let currentKgService = null;
        let currentCategoryService = null;

        // Initialize datetime min
        document.addEventListener('DOMContentLoaded', () => {
            const now = new Date();
            const minDateTime = now.toISOString().slice(0, 16);
            document.getElementById('pickup-datetime').min = minDateTime;
            document.getElementById('delivery-datetime').min = minDateTime;
        });

        // KG Modal Functions
        function openKgModal(serviceId, serviceName, pricePerKg) {
            currentKgService = { id: serviceId, name: serviceName, pricePerKg };
            document.getElementById('kg-modal-title').textContent = serviceName;
            document.getElementById('kg-input').value = 1;
            updateKgPreview();
            document.getElementById('kg-modal').classList.add('active');
        }
        window.openKgModal = openKgModal;

        function closeKgModal() {
            document.getElementById('kg-modal').classList.remove('active');
            currentKgService = null;
        }
        window.closeKgModal = closeKgModal;

        function updateKgPreview() {
            if (!currentKgService) return;
            const kg = parseFloat(document.getElementById('kg-input').value) || 0;
            const price = kg * currentKgService.pricePerKg;
            document.getElementById('kg-preview-price').textContent = `LKR ${price.toLocaleString()}`;
            document.getElementById('kg-confirm-btn').disabled = kg <= 0;
        }
        window.updateKgPreview = updateKgPreview;

        function confirmKgService() {
            const kg = parseFloat(document.getElementById('kg-input').value) || 0;
            if (kg <= 0) return;

            const price = kg * currentKgService.pricePerKg;
            const existingIndex = orderItems.findIndex(item => item.serviceId === currentKgService.id);

            const newItem = {
                serviceId: currentKgService.id,
                serviceName: currentKgService.name,
                type: 'kg',
                quantity: kg,
                unit: 'kg',
                price: price,
                itemCount: 0
            };

            if (existingIndex >= 0) {
                orderItems[existingIndex] = newItem;
            } else {
                orderItems.push(newItem);
            }

            closeKgModal();
            renderOrderItems();
            updateTotals();
            if (window.toastSuccess) window.toastSuccess(`Added ${kg} kg of ${currentKgService.name}`);
        }
        window.confirmKgService = confirmKgService;

        // Category Modal Functions
        function openCategoryModal(serviceId, serviceName) {
            currentCategoryService = { id: serviceId, name: serviceName };
            document.getElementById('category-modal-title').textContent = serviceName;

            const isPressing = serviceId === 'pressing';
            const tbody = document.getElementById('category-table-body');
            tbody.innerHTML = '';

            CATEGORIES.forEach((cat, index) => {
                const price = isPressing ? cat.pressingPrice : cat.washIronPrice;
                tbody.innerHTML += `
                    <tr>
                        <td>${cat.name}</td>
                        <td>LKR ${price}</td>
                        <td><input type="number" id="cat-qty-${index}" min="0" value="0" data-price="${price}" oninput="updateCategoryTotal()" /></td>
                    </tr>
                `;
            });

            updateCategoryTotal();
            document.getElementById('category-modal').classList.add('active');
        }
        window.openCategoryModal = openCategoryModal;

        function closeCategoryModal() {
            document.getElementById('category-modal').classList.remove('active');
            currentCategoryService = null;
        }
        window.closeCategoryModal = closeCategoryModal;

        function updateCategoryTotal() {
            let totalItems = 0;
            let totalPrice = 0;

            CATEGORIES.forEach((cat, index) => {
                const input = document.getElementById(`cat-qty-${index}`);
                if (input) {
                    const qty = parseInt(input.value) || 0;
                    const price = parseInt(input.dataset.price) || 0;
                    totalItems += qty;
                    totalPrice += qty * price;
                }
            });

            document.getElementById('category-items').textContent = totalItems;
            document.getElementById('category-total-price').textContent = `LKR ${totalPrice.toLocaleString()}`;
            document.getElementById('category-confirm-btn').disabled = totalItems === 0;
        }
        window.updateCategoryTotal = updateCategoryTotal;

        function confirmCategoryService() {
            const isPressing = currentCategoryService.id === 'pressing';
            let details = [];
            let totalItems = 0;
            let totalPrice = 0;

            CATEGORIES.forEach((cat, index) => {
                const input = document.getElementById(`cat-qty-${index}`);
                if (input) {
                    const qty = parseInt(input.value) || 0;
                    const price = isPressing ? cat.pressingPrice : cat.washIronPrice;
                    if (qty > 0) {
                        details.push({ category: cat.name, quantity: qty, pricePerItem: price, subtotal: qty * price });
                        totalItems += qty;
                        totalPrice += qty * price;
                    }
                }
            });

            if (totalItems === 0) return;

            const existingIndex = orderItems.findIndex(item => item.serviceId === currentCategoryService.id);
            const newItem = {
                serviceId: currentCategoryService.id,
                serviceName: currentCategoryService.name,
                type: 'category',
                details: details,
                price: totalPrice,
                itemCount: totalItems
            };

            if (existingIndex >= 0) {
                orderItems[existingIndex] = newItem;
            } else {
                orderItems.push(newItem);
            }

            closeCategoryModal();
            renderOrderItems();
            updateTotals();
            if (window.toastSuccess) window.toastSuccess(`Added ${totalItems} items for ${currentCategoryService.name}`);
        }
        window.confirmCategoryService = confirmCategoryService;

        // Express & Premium Toggles
        function toggleExpress() {
            const checkbox = document.getElementById('addon-express');
            checkbox.checked = !checkbox.checked;
            updateTotals();
        }
        window.toggleExpress = toggleExpress;

        function togglePremium() {
            const checkbox = document.getElementById('addon-premium');
            checkbox.checked = !checkbox.checked;
            updateTotals();
        }
        window.togglePremium = togglePremium;

        // Render Order Items
        function renderOrderItems() {
            const container = document.getElementById('order-items');

            if (orderItems.length === 0) {
                container.innerHTML = '<div class="empty-cart">No services selected yet</div>';
                return;
            }

            let html = '';
            orderItems.forEach((item, index) => {
                html += `<div class="order-item">`;
                if (item.type === 'kg') {
                    html += `<span class="order-item-name">${item.serviceName} (${item.quantity} kg)</span>`;
                } else {
                    html += `<span class="order-item-name">${item.serviceName} (${item.itemCount} items)</span>`;
                }
                html += `
                    <span>
                        <span class="order-item-price">LKR ${item.price.toLocaleString()}</span>
                        <button class="order-item-remove" onclick="removeItem(${index})">âœ•</button>
                    </span>
                </div>`;
            });

            container.innerHTML = html;
        }

        function removeItem(index) {
            orderItems.splice(index, 1);
            renderOrderItems();
            updateTotals();
        }
        window.removeItem = removeItem;

        // Update Totals
        function updateTotals() {
            const subtotal = orderItems.reduce((sum, item) => sum + item.price, 0);
            const totalItems = orderItems.reduce((sum, item) => sum + (item.itemCount || 0), 0);

            const expressChecked = document.getElementById('addon-express').checked;
            const premiumChecked = document.getElementById('addon-premium').checked;

            const expressAmount = expressChecked ? subtotal * EXPRESS_MULTIPLIER : 0;
            const premiumAmount = premiumChecked ? totalItems * PREMIUM_PER_ITEM : 0;
            const grandTotal = subtotal + expressAmount + premiumAmount;

            document.getElementById('subtotal').textContent = `LKR ${subtotal.toLocaleString()}`;
            document.getElementById('express-row').style.display = expressChecked ? 'flex' : 'none';
            document.getElementById('express-amount').textContent = `LKR ${expressAmount.toLocaleString()}`;
            document.getElementById('premium-row').style.display = premiumChecked ? 'flex' : 'none';
            document.getElementById('premium-amount').textContent = `LKR ${premiumAmount.toLocaleString()}`;
            document.getElementById('grand-total').textContent = `LKR ${grandTotal.toLocaleString()}`;

            validateForm();
        }
        window.updateTotals = updateTotals;

        // Date Validation
        function validateDates() {
            const pickupInput = document.getElementById('pickup-datetime');
            const deliveryInput = document.getElementById('delivery-datetime');
            const now = new Date();
            const pickup = new Date(pickupInput.value);
            const delivery = new Date(deliveryInput.value);

            let valid = true;
            if (pickupInput.value && pickup <= now) valid = false;
            if (deliveryInput.value && pickupInput.value && delivery <= pickup) valid = false;

            validateForm();
            return valid;
        }
        window.validateDates = validateDates;

        function validateForm() {
            const pickupInput = document.getElementById('pickup-datetime');
            const deliveryInput = document.getElementById('delivery-datetime');
            const btn = document.getElementById('btn-place-order');

            const hasItems = orderItems.length > 0;
            const hasPickup = pickupInput.value !== '';
            const hasDelivery = deliveryInput.value !== '';

            let datesValid = true;
            if (hasPickup && hasDelivery) {
                const now = new Date();
                const pickup = new Date(pickupInput.value);
                const delivery = new Date(deliveryInput.value);
                datesValid = pickup > now && delivery > pickup;
            }

            btn.disabled = !(hasItems && hasPickup && hasDelivery && datesValid);
        }

        // Place Order
        async function placeOrder() {
            const btn = document.getElementById('btn-place-order');
            btn.disabled = true;
            btn.textContent = 'Processing...';

            try {
                // Simulate API call
                await new Promise(resolve => setTimeout(resolve, 1500));

                if (window.toastSuccess) window.toastSuccess('Order placed successfully!');

                // Reset form
                orderItems = [];
                renderOrderItems();
                updateTotals();
                document.getElementById('pickup-datetime').value = '';
                document.getElementById('delivery-datetime').value = '';
                document.getElementById('addon-express').checked = false;
                document.getElementById('addon-premium').checked = false;

                // Switch to My Orders
                document.querySelector('[data-section="my-orders"]').click();
            } catch (error) {
                if (window.toastError) window.toastError('Failed to place order');
            } finally {
                btn.textContent = 'Place Order';
                validateForm();
            }
        }
        window.placeOrder = placeOrder;

        // Chat
        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message) return;

            const container = document.getElementById('chat-messages');
            container.innerHTML += `
                <div style="text-align: right; margin-bottom: 12px;">
                    <span style="background: var(--primary); color: white; padding: 10px 16px; border-radius: 16px 16px 0 16px; display: inline-block; max-width: 80%;">
                        ${message}
                    </span>
                </div>
            `;
            input.value = '';
            container.scrollTop = container.scrollHeight;
        }
        window.sendMessage = sendMessage;
    </script>
</body>

</html>